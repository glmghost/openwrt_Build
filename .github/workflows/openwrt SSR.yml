#=================================================
# Description: Build OpenWrt using GitHub Actions
# License: MIT
# Author: kenzo (fixed SSH functionality)
#=================================================

name: OpenWrt-24.10 helloworld config

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
      minimal:
        description: 'Minimal build (without Rust)'
        required: false
        default: 'false'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  SSH_PRIVATE_KEY:  $ {{ secrets.SSH_PRIVATE_KEY }}
  PASSWORD:  $ {{ secrets.PASSWORD }}
  REMOTE_HOST:  $ {{ secrets.REMOTE_HOST }}
  REMOTE_PORT:  $ {{ secrets.REMOTE_PORT }}
  DOCKER_ID:  $ {{ secrets.DOCKER_ID }}
  DOCKER_PASSWD:  $ {{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai
  MTARGET: "x86_64"  # æ ¹æ®æ‚¨çš„ç›®æ ‡è®¾å¤‡ä¿®æ”¹
  CONFIG_DIR: "."
  # ä¿®å¤ Rust æž„å»ºé—®é¢˜çš„å…³é”®çŽ¯å¢ƒå˜é‡
  RUST_BACKTRACE: 1
  LLVM_DOWNLOAD_CI_LLVM: "if-unchanged"

jobs:
  merge:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    name: Build  $ {{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [OpenWrt-24.10]

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget scdoc \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev \
        libzstd-dev liblz4-dev liblzo2-dev libbrotli-dev libz-dev \
        liblzma-dev libtool autoconf automake pkg-config cpio
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
        
        # æ¸…ç†å¯èƒ½æŸåçš„å·¥å…·é“¾
        sudo rm -rf /usr/share/aclocal/libtool.m4

    - name: Get current date
      id: date
      run: |
        echo "date= $ (date +'%Y.%m.%d-%H%M')" >>  $ GITHUB_ENV
        echo "date2= $ (date +'%m/%d %Y')" >>  $ GITHUB_ENV
        echo "date3= $ (date +'%m.%d')" >>  $ GITHUB_ENV
        echo "DOCKERTAG= $ {{ secrets.DOCKER_ID }}/openwrt-6p:latest" >>  $ GITHUB_ENV
        VERSION=" $ (echo " $ {{github.event.action}}" | grep -Eo " [0-9.]+" | sed -e 's/ //')" || true
        [ " $ VERSION" ] && echo "VERSION= $ VERSION" >>  $ GITHUB_ENV || echo "VERSION= $ (date +'%m.%d')" >>  $ GITHUB_ENV

    - name: Clone source code
      env:
        REPO_URL: https://github.com/openwrt/openwrt
        REPO_BRANCH: openwrt-24.10
      run: |
        # ä¿®å¤å˜é‡å¼•ç”¨è¯­æ³• - æ­£ç¡®çš„æ–¹å¼
        git clone " $ REPO_URL" -b " $ REPO_BRANCH" openwrt
        cd openwrt
        echo "src-git helloworld https://github.com/fw876/helloworld.git" >> feeds.conf.default
        # ç¡®ä¿ libtool è¢«å¯ç”¨
        echo "CONFIG_PACKAGE_libtool=y" >> .config 2>/dev/null || true

    - name: Free up disk space
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/bin /mnt/openwrt/staging_dir \
          /mnt/openwrt/build_dir /mnt/openwrt/tmp
        
        sudo mount -t tmpfs -o size=2G tmpfs /mnt/openwrt/tmp
        
        ln -sf /mnt/openwrt/dl openwrt/dl
        ln -sf /mnt/openwrt/bin openwrt/bin
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sf /mnt/openwrt/build_dir openwrt/build_dir
        ln -sf /mnt/openwrt/tmp openwrt/tmp

    - name: Update feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a

    - name: Defconfig  $ {{matrix.target}}
      env:
        CONFIG_FILE: ' $ {{matrix.target}}.config'
        MINIMAL_BUILD:  $ {{ github.event.inputs.minimal || 'false' }}
      run: |
        cd openwrt

        # 1. åŠ è½½ä¸»é…ç½®æ–‡ä»¶
        if [ -e "../ $ {CONFIG_DIR:-.}/ $ {CONFIG_FILE}" ]; then
          cp "../ $ {CONFIG_DIR:-.}/ $ {CONFIG_FILE}" .config
          echo "âœ… Using custom config:  $ {CONFIG_FILE}"
        elif [ -e "../.config" ]; then
          cp "../.config" .config
          echo "âœ… Using fallback .config from repo root"
        else
          echo "âŒ No .config found! Build will fail."
          exit 1
        fi

        # 2. å¦‚æžœæ˜¯ç²¾ç®€æž„å»ºï¼Œç¦ç”¨ Rust ç›¸å…³åŒ…
        if [ " $ MINIMAL_BUILD" = "true" ]; then
          echo "âš ï¸  Performing minimal build - disabling Rust packages"
          sed -i '/CONFIG_PACKAGE_rust/d' .config
          echo "CONFIG_PACKAGE_rust=n" >> .config
          sed -i '/CONFIG_PACKAGE_rust-std/d' .config
          echo "CONFIG_PACKAGE_rust-std=n" >> .config
          sed -i '/CONFIG_PACKAGE_cargo/d' .config
          echo "CONFIG_PACKAGE_cargo=n" >> .config
        fi

        # 3. å¤„ç† customize.sh
        if [ -e "../customize.sh" ]; then
          echo "âœ… Found customize.sh, running..."
          cp ../customize.sh .
          chmod +x ./customize.sh
          ./customize.sh
        fi

        # 4. æ›´æ–°å¹¶å®‰è£… feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

        # 5. ç”Ÿæˆæœ€ç»ˆé…ç½®
        echo "âœ… Finalizing configuration with make defconfig..."
        make defconfig
        
        # 6. ç¡®ä¿ libtool æ­£ç¡®é…ç½®
        echo "CONFIG_PACKAGE_libtool=y" >> .config
        echo "CONFIG_PACKAGE_automake=y" >> .config
        echo "CONFIG_PACKAGE_autoconf=y" >> .config
        make defconfig

        # 7. ä¿®å¤ Rust æž„å»ºé—®é¢˜ï¼šç¡®ä¿ config.toml åŒ…å«æ­£ç¡®çš„è®¾ç½®
        RUST_CONFIG_TOML="build_dir/target-x86_64_musl/host/rustc-1.89.0-src/config.toml"
        if [ -f " $ RUST_CONFIG_TOML" ]; then
          echo "ðŸ”§ Fixing Rust config.toml for CI compatibility..."
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è®¾ç½®
          sed -i '/llvm.download-ci-llvm/d' " $ RUST_CONFIG_TOML"
          # æ·»åŠ æ­£ç¡®çš„è®¾ç½®
          echo "llvm.download-ci-llvm = \"if-unchanged\"" >> " $ RUST_CONFIG_TOML"
        else
          echo "âš ï¸  Warning: Rust config.toml not found at  $ RUST_CONFIG_TOML"
        fi

    - name: Load custom configuration
      run: |
        # å¤„ç†æ ¹ç›®å½•çš„ .config æ–‡ä»¶
        if [ -e ./.config ]; then
          echo "âœ… Found .config in GitHub repo root, syncing to openwrt build dir"
          cp -f ./.config ./openwrt/.config
        fi

        # å¤„ç†æ ¹ç›®å½•çš„ files ç›®å½•
        if [ -d ./files ]; then
          echo "âœ… Found files directory in GitHub repo root, moving to openwrt dir"
          mv -f ./files ./openwrt/files
        fi

        # éªŒè¯ openwrt ç›®å½•ä¸‹çš„é…ç½®
        cd ./openwrt
        if [ -e ./.config ]; then
          echo "âœ… Validating .config and finalizing configuration..."
          make defconfig
        fi

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID:  $ {{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN:  $ {{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package
      working-directory: ./openwrt
      run: |
        # é¢„ä¸‹è½½ libtool ä»¥é¿å…æž„å»ºé—®é¢˜
        ./scripts/feeds install libtool
        ./scripts/feeds install automake
        ./scripts/feeds install autoconf
        
        # ä¿®æ­£çº¿ç¨‹æ•°è®¡ç®—
        THREADS= $ ((  $ (nproc) - 2 ))
        [  $ THREADS -lt 1 ] && THREADS=1
        echo "Using  $ THREADS threads for download"
        
        make download -j $ THREADS
        find dl -size -1024c -exec rm -f {} \;

    - name: Cache
      uses: stupidloud/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey:  $ {{ matrix.target }}
        clean:  $ {{ contains(github.event.action, 'nocache') }}
        prefix:  $ {{ github.workspace }}/openwrt

    - name: Check space usage
      run: |
        echo "Disk space before build:"
        df -hT
        echo "Inode usage:"
        df -i
        
        cd openwrt
        # ç¡®ä¿ staging_dir ç»“æž„æ­£ç¡®
        mkdir -p staging_dir/host/bin staging_dir/host/lib staging_dir/host/include

    - name: Compile the firmware
      id: compile
      working-directory: ./openwrt
      env:
        # ä¿®å¤ Rust æž„å»ºçš„å…³é”®çŽ¯å¢ƒå˜é‡
        LLVM_DOWNLOAD_CI_LLVM: "if-unchanged"
        # å¢žåŠ  ulimit é™åˆ¶
        ULIMIT: unlimited
      run: |
        # å¢žåŠ  ulimit é™åˆ¶
        ulimit -s unlimited
        ulimit -n 4096
        
        echo "=== Final .config summary ==="
        grep -E "CONFIG_TARGET_|CONFIG_PACKAGE_" .config | head -n 30
        echo "=== Disabled packages ==="
        grep -E "^# CONFIG_PACKAGE_" .config | head -n 20
        
        # é‡ç½® libtool ç›¸å…³ç›®å½•ï¼Œé¿å…æž„å»ºé”™è¯¯
        if [ -d "build_dir/host/libtool*" ]; then
          echo "ðŸ§¹ Cleaning up libtool build directory..."
          rm -rf build_dir/host/libtool*
        fi
        
        # å°è¯•å…ˆæž„å»º host tools
        echo "ðŸ”§ Building host tools first..."
        make tools/install -j $ ((  $ (nproc) - 2 )) || {
          echo "âš ï¸  Host tools build failed, but continuing with main build"
          true  # å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ
        }
        
        # æž„å»º libtool å•ç‹¬
        echo "ðŸ”§ Building libtool separately..."
        make package/libs/libtool/compile -j $ ((  $ (nproc) - 2 )) || {
          echo "âš ï¸  Libtool build failed, but continuing with main build"
          true  # å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ
        }
        
        # ä¸»æž„å»ºè¿‡ç¨‹
        echo "ðŸš€ Starting main build process..."
        make -j $ ((  $ (nproc) - 2 )) || {
          echo "âš ï¸  First build attempt failed, retrying with fewer jobs..."
          make -j2 V=s || {
            echo "âŒ Build failed completely"
            exit 1
          }
        }
        
        echo "âœ… Build completed successfully!"

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outcome == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin $ {{ env.DEVICE_NAME }} $ {{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outcome == 'success'
      run: |
        mkdir -p firmware
        cd openwrt/bin/targets/*/*/
        
        # åªå¤åˆ¶å¿…è¦çš„å›ºä»¶æ–‡ä»¶
        for file in *sysupgrade*.bin *sysupgrade*.tar *combined*.bin *combined*.img *combined-efi*.bin *combined-efi*.img; do
          [ -f " $ file" ] && cp " $ file" ../../../../../firmware/
        done
        
        cd ../../../../..
        cp openwrt/.config  ./firmware/ $ {{matrix.target}}.config 2>/dev/null || true
        mkdir -p ./firmware/kernel-config
        cp openwrt/build_dir/target-*/linux-*/linux-*/.config ./firmware/kernel-config/ $ {{matrix.target}}_kernel.config 2>/dev/null || true
        
        cd firmware
        echo "v $ {{ env.date2 }}" > version.txt
        for file in *sysupgrade*.bin *sysupgrade*.tar *combined*.bin *combined*.img *combined-efi*.bin *combined-efi*.img; do
          [ -f " $ file" ] && md5sum " $ file" | awk '{print  $ 1}' >> version.txt
        done
        rename -v "s/^openwrt/ $ {{ env.VERSION }}-openwrt/" * 2>/dev/null || true
        rename -v "s/friendlyarm_//" *gz 2>/dev/null || true
        echo " $ {{matrix.target}}" >> version.txt
        echo "Build date:  $ {{ env.date }}" >> version.txt
        rm -f sha256sums 2>/dev/null || true
        echo "FIRMWARE= $ PWD" >>  $ GITHUB_ENV

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outcome == 'success'
      with:
        name: OpenWrt_firmware $ {{ env.DEVICE_NAME }} $ {{ env.FILE_DATE }}
        path:  $ {{ env.FIRMWARE }}

    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outcome == 'success' && env.UPLOAD_COWTRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress  $ {FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com:: $ (cat cowtransfer.log | grep https)"
        echo "url= $ (cat cowtransfer.log | grep https | cut -f3 -d' ')" >>  $ GITHUB_OUTPUT

    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outcome == 'success' && env.UPLOAD_WETRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress  $ {FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com:: $ (cat wetransfer.log | grep https)"
        echo "url= $ (cat wetransfer.log | grep https | cut -f3 -d' ')" >>  $ GITHUB_OUTPUT

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.organize.outcome == 'success'
      run: |
        echo "release_tag= $ (date +"%Y.%m.%d-%H%M")" >>  $ GITHUB_OUTPUT
        touch release.txt
        echo "# OpenWrt Firmware Release" > release.txt
        echo "" >> release.txt
        echo "Build Date:  $ {{ env.date2 }}" >> release.txt
        echo "Target:  $ {{matrix.target}}" >> release.txt
        echo "" >> release.txt
        echo "## Downloads" >> release.txt
        
        [  $ UPLOAD_COWTRANSFER = true ] && echo "- [Download via Cowtransfer]( $ {{ steps.cowtransfer.outputs.url }})" >> release.txt
        [  $ UPLOAD_WETRANSFER = true ] && echo "- [Download via WeTransfer]( $ {{ steps.wetransfer.outputs.url }})" >> release.txt
        
        echo "" >> release.txt
        echo "## File Checksums" >> release.txt
        echo "\`\`\`" >> release.txt
        cat  $ {{ env.FIRMWARE }}/version.txt >> release.txt
        echo "\`\`\`" >> release.txt
        
        echo "status=success" >>  $ GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN:  $ {{ secrets.GITHUB_TOKEN }}
      with:
        tag_name:  $ {{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files:  $ {{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: glmghost/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.3.0
      if: env.UPLOAD_RELEASE == 'true' && steps.tag.outputs.status == 'success'
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN:  $ {{ secrets.GITHUB_TOKEN }}
