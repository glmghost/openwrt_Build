#=================================================
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: kenzo
#=================================================

name: openwrt SSR

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PASSWORD: ${{ secrets.PASSWORD }}
  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
  DOCKER_ID: ${{ secrets.DOCKER_ID }}
  DOCKER_PASSWD: ${{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai
  # å…¨å±€è®¾ç½®rustç¼–è¯‘çŽ¯å¢ƒå˜é‡ï¼Œé¿å…llvmå‚æ•°é”™è¯¯
  LLVM_DOWNLOAD_CI_LLVM: if-unchanged
  RUST_BACKTRACE: 1

jobs:
  merge:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    name: Build ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [Lean]

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Free disk space
        uses: coder-xiaomo/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget scdoc \
          llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
          libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev
          # å®‰è£…rustç¼–è¯‘ä¾èµ–ï¼ˆè¡¥å……ç¼ºå¤±çš„ä¾èµ–ï¼Œæ¶ˆé™¤è­¦å‘Šï¼‰
          sudo apt-get -qq install libssl-dev pkg-config
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
          echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
          if [ -n "${{ secrets.DOCKER_ID }}" ]; then
            echo "DOCKERTAG=${{ secrets.DOCKER_ID }}/openwrt-6p:latest" >> $GITHUB_ENV
          else
            echo "DOCKERTAG=openwrt-6p:latest" >> $GITHUB_ENV
          fi
          VERSION="$(echo "${{github.event.action}}" | grep -Eo " [0-9.]+" | sed -e 's/ //')" || true
          [ "$VERSION" ] && echo "VERSION=$VERSION" >> $GITHUB_ENV || echo "VERSION=$(date +'%m.%d')" >> $GITHUB_ENV

      - name: Clone source code
        env:
          REPO_URL: https://github.com/openwrt/openwrt
          REPO_BRANCH: openwrt-24.10
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          # ä»…ä¿ç•™helloworldæºï¼Œç§»é™¤smpackageæº
          sed -i '$a src-git helloworld https://github.com/fw876/helloworld' feeds.conf.default
          # æ¸…ç† feedsï¼Œåªæ›´æ–° helloworld å’ŒåŸºç¡€ feeds
          ./scripts/feeds clean
          ./scripts/feeds update -i -f helloworld
          ./scripts/feeds install -i -f -p helloworld -a


      - name: Free up disk space
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/bin /mnt/openwrt/staging_dir
          ln -sf /mnt/openwrt/dl openwrt/dl
          ln -sf /mnt/openwrt/bin openwrt/bin
          ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir

      - name: Update feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          # ç¡®ä¿rustç›¸å…³åŒ…æ­£å¸¸å®‰è£…ï¼ˆä¿ç•™helloworldçš„rustä¾èµ–åŒ…ï¼‰
          ./scripts/feeds install -a rust rustc
          ./scripts/feeds install -a dns2socks-rust shadow-tls shadowsocks-rust tuic-client
          ./scripts/feeds install -a

      - name: Defconfig ${{matrix.target}}
        env:
          CONFIG_FILE: '${{matrix.target}}.config'
        run: |
          cd openwrt
          # ç¬¬ä¸€æ­¥ï¼šå…ˆç”Ÿæˆé»˜è®¤.configï¼Œç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼Œæ¶ˆé™¤é…ç½®ç¼ºå¤±è­¦å‘Š
          make defconfig

          # ä¼˜å…ˆä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„é…ç½®æ–‡ä»¶ï¼ˆè¦†ç›–é»˜è®¤é…ç½®ï¼‰
          if [ -e "../$CONFIG_FILE" ]; then
            mv "../$CONFIG_FILE" .config
            make defconfig
          fi

          # æ£€æŸ¥customize.shæ˜¯å¦å­˜åœ¨
          if [ -f ../customize.sh ]; then
            # --- ä¿®æ”¹ï¼šå…ˆæ·»åŠ æ‰§è¡Œæƒé™ ---
            echo "Found customize.sh, adding execute permission..."
            chmod +x ../customize.sh
            echo "Executing customize.sh..."
            # ä½¿ç”¨ bash -x æ¥æŸ¥çœ‹å…·ä½“å“ªä¸€è¡Œå‡ºé”™ï¼Œæ–¹ä¾¿è°ƒè¯•
            set -x 
            ../customize.sh || { echo "customize.sh failed, check the script content and paths."; exit 1; }
            set +x
            echo "customize.sh executed successfully."
          else
            echo "Info: customize.sh not found, skip execution"
          fi

          # --- ä¿®æ”¹ï¼šç§»é™¤æ‰‹åŠ¨æ›´æ–° Golang çš„æ­¥éª¤ ---
          # rm -rf feeds/packages/lang/golang
          # git clone https://github.com/kenzok8/golang -b 1.25 feeds/packages/lang/golang
          # -------------------------------

          # ç§»é™¤openclashï¼ˆåŽŸä¾èµ–smpackageï¼Œç¡®ä¿åªç”¨helloworldæºï¼‰
          rm -rf feeds/luci/applications/luci-app-openclash

          # è‡ªå®šä¹‰bannerå’Œä¸»é¢˜
          sed -i "s/%D %V, %C/openwrt $(date +'%m.%d') by kenzo/g" package/base-files/files/etc/banner
          sed -i 's/luci-theme-bootstrap/luci-theme-argon/g' feeds/luci/collections/luci/Makefile

          # å†æ¬¡æ›´æ–° feedsï¼Œç¡®ä¿æ‰€æœ‰æ›´æ”¹çš„é…ç½®ç”Ÿæ•ˆ
          ./scripts/feeds update -a
          # v2datå®¹é”™å¤„ç†
          if [ -f feeds/packages/utils/v2dat/Makefile ]; then
            sed -i 's#GO_PKG_TARGET_VARS.*# #g' feeds/packages/utils/v2dat/Makefile
          else
            echo "Warning: feeds/packages/utils/v2dat/Makefile not found, skip sed modification"
          fi
          ./scripts/feeds install -a

          # ========== æ ¸å¿ƒä¿®å¤ï¼šä¿®å¤rustç¼–è¯‘çš„llvmå‚æ•°ï¼Œè§£å†³panic ==========
          # 1. æå‰å‡†å¤‡rustæºç ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶å¯ä¿®æ”¹
          make package/feeds/packages/rust/host/prepare -j1 V=s || echo "Warning: rust host prepare might have warnings/errors, continuing..."
          # 2. å…¨å±€æ›¿æ¢rusté…ç½®ä¸­çš„llvm.download-ci-llvmå‚æ•°ï¼ˆ100%ç”Ÿæ•ˆï¼‰
          # æ³¨æ„ï¼šfindå‘½ä»¤å¯èƒ½å› ä¸ºè¾“å‡ºå¤ªå¤šè€Œäº§ç”Ÿbroken pipeï¼Œä½¿ç”¨trueå¿½ç•¥é”™è¯¯
          find build_dir/target-*/host/rustc-*/ -name "config.rs" -exec sed -i \
          's/llvm.download-ci-llvm = true/llvm.download-ci-llvm = "if-unchanged"/g' {} \; 2>/dev/null || true
          find build_dir/target-*/host/rustc-*/ -name "config.rs" -exec sed -i \
          's/llvm.download-ci-llvm = false/llvm.download-ci-llvm = "if-unchanged"/g' {} \; 2>/dev/null || true
          # 3. éªŒè¯ä¿®æ”¹ç»“æžœï¼ˆå¤„ç†å¯èƒ½æ‰¾ä¸åˆ°æ–‡ä»¶çš„æƒ…å†µï¼‰
          RUST_CONFIG_PATH=$(find build_dir/target-*/host/rustc-*/ -name "config.rs" 2>/dev/null | head -n 1)
          if [ -n "$RUST_CONFIG_PATH" ] && [ -f "$RUST_CONFIG_PATH" ]; then
            grep "llvm.download-ci-llvm" "$RUST_CONFIG_PATH"
            echo "âœ… Rust config fixed successfully: llvm.download-ci-llvm = if-unchanged"
          else
            echo "âš ï¸  Rust config file not found in expected location. Fix via sed might not have applied. Relies on LLVM_DOWNLOAD_CI_LLVM env var."
          fi

          # ========== å¯ç”¨rustç›¸å…³é…ç½®ï¼Œæ¶ˆé™¤ä¾èµ–è­¦å‘Š ==========
          sed -i '/CONFIG_PACKAGE_rust/d' .config
          sed -i '/CONFIG_PACKAGE_rustc/d' .config
          sed -i '/CONFIG_HOST_RUSTC/d' .config
          sed -i '/CONFIG_FEED_rust/d' .config
          cat >> .config << EOF
          CONFIG_PACKAGE_rust=y
          CONFIG_PACKAGE_rustc=y
          CONFIG_HOST_RUSTC=y
          CONFIG_FEED_rust=y
          EOF
          # é‡æ–°ç”Ÿæˆé…ç½®
          make defconfig
          # éªŒè¯rusté…ç½®
          echo "===== Rust config check ====="
          grep -E "rust|HOST_RUSTC" .config
          echo "============================="
      - name: Load custom configuration
        run: |
          cd openwrt
          # å¤„ç†é¡¹ç›®æ ¹ç›®å½•çš„.configï¼ˆå†æ¬¡ç¡®ä¿ï¼‰
          if [ -e "../.config" ]; then
            # å¤‡ä»½å½“å‰ .config ä»¥é˜²ä¸‡ä¸€
            cp .config .config.bak
            # å¤åˆ¶ç”¨æˆ·æä¾›çš„é…ç½®
            cp -f ../.config .config
            # ç¡®ä¿rusté…ç½®å¯ç”¨ (å³ä½¿åœ¨ç”¨æˆ·é…ç½®ä¹‹åŽ)
            sed -i '/CONFIG_PACKAGE_rust/d' .config
            sed -i '/CONFIG_PACKAGE_rustc/d' .config
            sed -i '/CONFIG_HOST_RUSTC/d' .config
            sed -i '/CONFIG_FEED_rust/d' .config
            cat >> .config << EOF
            CONFIG_PACKAGE_rust=y
            CONFIG_PACKAGE_rustc=y
            CONFIG_HOST_RUSTC=y
            CONFIG_FEED_rust=y
            EOF
            # ç¡®ä¿ luci-theme-argon è¢«é€‰ä¸­ (å³ä½¿åœ¨ç”¨æˆ·é…ç½®ä¹‹åŽ)
            sed -i '/CONFIG_PACKAGE_luci-theme-bootstrap/d' .config
            sed -i '/CONFIG_PACKAGE_luci-theme-argon/d' .config
            echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-openclash=n" >> .config # ç¡®ä¿openclashæœªé€‰ä¸­
            make defconfig
            echo "âœ… å·²åŒæ­¥é¡¹ç›®æ ¹ç›®å½•.configï¼Œå¯ç”¨rustå¹¶ç¡®ä¿argonä¸»é¢˜"
          fi

          # å¤„ç†filesç›®å½•
          if [ -d "../files" ]; then
            mv -f ../files ./files
            echo "âœ… å·²åŒæ­¥é¡¹ç›®æ ¹ç›®å½•files"
          fi

          # éªŒè¯æœ€ç»ˆé…ç½®
          make defconfig
          echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: github.event.inputs.ssh == 'true'
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: Download package
        working-directory: ./openwrt
        run: |
          make download -j$(($(nproc)+1))
          find dl -size -1024c -exec rm -f {} \;

      - name: Cache
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          mixkey: ${{ matrix.target }}
          clean: ${{ contains(github.event.action, 'nocache') }}
          prefix: ${{ github.workspace }}/openwrt

      - name: Check space usage
        run: |
          shopt -s extglob
          cd openwrt
          # --- ä¿®æ”¹ï¼šç®€åŒ–ç©ºé—´æ¸…ç†é€»è¾‘ï¼Œç§»é™¤å¯¹æœªå®šä¹‰å˜é‡ MTARGET çš„å¼•ç”¨ ---
          # if [[ -f staging_dir/*${{ env.MTARGET }}*/bin ]]; then
          #     rm -rf staging_dir/!(*${{ env.MTARGET }}*|host|hostpkg) build_dir/!(*${{ env.MTARGET }}*|host|hostpkg)
          # fi
          rm -rf build_dir/host* build_dir/toolchain-* 2>/dev/null || true # æ¸…ç†ä¸€äº›é€šç”¨çš„å¤§ç›®å½•
          df -hT

      - name: Compile the firmware
        working-directory: ./openwrt
        run: |
          echo -e "$(($(nproc)+1)) thread compile"
          # ç¬¬ä¸€æ­¥ï¼šå•ç‹¬ç¼–è¯‘rust hoståŒ…ï¼ˆç¡®ä¿é…ç½®ä¿®å¤ç”Ÿæ•ˆï¼‰
          make package/feeds/packages/rust/host/compile -j1 V=s || make package/feeds/packages/rust/host/compile -j1 V=s
          # ç¬¬äºŒæ­¥ï¼šç¼–è¯‘æ•´ä½“å›ºä»¶
          make -j$(($(nproc)+1)) || make -j1 V=s

      - name: Upload bin directory
        uses: actions/upload-artifact@main
        if: success() && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin_${{matrix.target}}_${{ env.date }} # --- ä¿®æ”¹ï¼šä½¿ç”¨å·²å®šä¹‰çš„ date å˜é‡ ---
          path: openwrt/bin

      - name: Organize files
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir firmware
          mv -f openwrt/bin/targets/*/*/{*combined*,*sysupgrade*} ./firmware/ 2>/dev/null || true
          cp openwrt/.config  ./firmware/${{matrix.target}}.config
          cp openwrt/build_dir/target-*/linux-*/linux-*/.config ./firmware/${{matrix.target}}_kernel.config
          cd firmware
          echo "v${{ env.date2 }}" > version.txt
          md5=$((md5sum *squashfs-sysupgrade* || md5sum *squashfs-combined-efi*) | awk '{print $1}') 2>/dev/null
          echo $md5 >> version.txt
          rename -v "s/^openwrt/${{ env.VERSION }}-openwrt/" * || true
          rename -v "s/friendlyarm_//" *gz || true
          echo $md5 >> version.txt
          echo ${{matrix.target}} >> version.txt
          rm -rf sha256sums
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Upload firmware directory
        uses: actions/upload-artifact@main
        if: steps.organize.outcome == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware_${{matrix.target}}_${{ env.date }} # --- ä¿®æ”¹ï¼šä½¿ç”¨å·²å®šä¹‰çš„ date å˜é‡ ---
          path: ${{ env.FIRMWARE }}

      - name: Upload firmware to cowtransfer
        id: cowtransfer
        if: steps.organize.outcome == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: Upload firmware to WeTransfer
        id: wetransfer
        if: steps.organize.outcome == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: Generate release tag
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          [ $UPLOAD_COWTRANSFER = true ] && echo "ðŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
          [ $UPLOAD_WETRANSFER = true ] && echo "ðŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outcome == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: Delete workflow runs
        uses: glmghost/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.2.1
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
